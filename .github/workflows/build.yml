name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    strategy:
      matrix:
        platform: [ ubuntu-latest, windows-latest, macos-latest ]
    runs-on: ${{ matrix.platform }}

    steps:
    - uses: actions/checkout@v4

    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          libx11-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libgl1-mesa-dev \
          libgl-dev

    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/vcpkg_installed
          ${{ github.workspace }}/vcpkg/buildtrees
          ${{ github.workspace }}/vcpkg/packages
        key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}

    - name: vcpkg (manifest mode)
      uses: johnwason/vcpkg-action@v7
      with:
        manifest-dir: ${{ github.workspace }}
        triplet: ${{ matrix.platform == 'windows-latest' && 'x64-windows' || matrix.platform == 'macos-latest' && 'x64-osx' || 'x64-linux' }}
        token: ${{ github.token }}

    - name: Configure CMake
      run: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake

    - name: Build
      shell: bash
      run: cmake --build build --config Release --parallel

    - name: Install
      run: cmake --install build --config Release --prefix install

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.platform }}
        path: install/
